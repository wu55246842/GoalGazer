name: Update Match Content


on:
  workflow_dispatch:
    inputs:
      league:
        description: 'League Code (e.g., epl, liga, bundesliga, seriea, ligue1, all)'
        required: false
        default: 'all'
      season:
        description: 'Season year (e.g., 2025)'
        required: false
        default: '2025'
      matchId:
        description: 'Match ID to analyze (optional, otherwise latest finished match)'
        required: false
        type: string
  schedule:
    - cron: '0 */2 * * *'   # ÊØè 2 Â∞èÊó∂‰∏ÄÊ¨°ÔºàÂºÄÂèëÊúüÔºâ

concurrency:
  group: update-match-content
  cancel-in-progress: true

jobs:
  update-content:
    runs-on: ubuntu-latest
    timeout-minutes: 110
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        league: [epl, liga, bundesliga, seriea, ligue1]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node Dependencies
        run: npm ci

      - name: Install Python Dependencies
        working-directory: ./tools/pipeline/python
        run: |
          pip install -r requirements.txt

      - name: Run Analysis Pipeline
        env:
          API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          POLLINATIONS_API_KEY: ${{ secrets.POLLINATIONS_API_KEY }}
          POIXE_API_KEY: ${{ secrets.POIXE_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
          FOOTBALL_DATA_API_TOKEN: ${{ secrets.FOOTBALL_DATA_API_TOKEN }}
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
          ALLSPORTSAPI_API_KEY: ${{ secrets.ALLSPORTSAPI_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        run: |
          # 1. Determine which league to process
          # If matrix is running, we use matrix.league.
          # If it's a manual run with a specific league, we only run if matrix.league matches that league.
          
          MATRIX_LEAGUE="${{ matrix.league }}"
          INPUT_LEAGUE="${{ github.event.inputs.league || 'all' }}"
          SEASON_INPUT="${{ github.event.inputs.season || '2025' }}"
          MATCH_ID_INPUT="${{ github.event.inputs.matchId }}"

          echo "üîç Checking if we should process $MATRIX_LEAGUE..."
          
          SHOULD_RUN=false
          if [ "$INPUT_LEAGUE" = "all" ]; then
            SHOULD_RUN=true
          elif [ "$INPUT_LEAGUE" = "$MATRIX_LEAGUE" ]; then
            SHOULD_RUN=true
          fi

          if [ "$SHOULD_RUN" = "true" ]; then
            echo "üöÄ Processing League: $MATRIX_LEAGUE (Season: $SEASON_INPUT)"
            if [ -n "$MATCH_ID_INPUT" ]; then
              npm run pipeline -- --league "$MATRIX_LEAGUE" --season "$SEASON_INPUT" --matchId "$MATCH_ID_INPUT"
            else
              npm run pipeline -- --league "$MATRIX_LEAGUE" --season "$SEASON_INPUT"
            fi
          else
            echo "‚è≠Ô∏è  Skipping $MATRIX_LEAGUE (Not requested in input)"
          fi

      - name: Generate Daily Digest
        env:
            DATABASE_URL: ${{ secrets.DATABASE_URL }}
            OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
            POLLINATIONS_API_KEY: ${{ secrets.POLLINATIONS_API_KEY }}
            S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
            S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
            S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
            S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
            R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        run: |
          # Only run daily digest once (e.g. for one specific league in the matrix, or using a separate job)
          # Since matrix runs in parallel, we want to avoid 5 runs of daily digest.
          # We check if matrix.league == 'epl' (or any single one) to run it only once.
          
          # Run daily digest for the current league in the matrix
          echo "üåû Running Daily Digest Generation for ${{ matrix.league }}..."
          npx tsx tools/pipeline/node/generate_daily_digest.ts --league ${{ matrix.league }}
